// PostgreSQL version of Prisma schema for production deployment
// This is the PRODUCTION schema - replace schema.prisma before deploy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== TENANT & USER ====================

model Tenant {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  
  // SUBSCRIPTION (v2.1 Dynamic Plans)
  planId             String?  // Link to Plan Table
  plan               Plan?    @relation(fields: [planId], references: [id])
  
  // Legacy fields (will be migrated)
  planTier           String   @default("DEMO") 
  subscriptionStatus String   @default("ACTIVE") // ACTIVE, TRIAL, SUSPENDED, CANCELLED
  trialEndsAt        DateTime?
  subscriptionStartedAt DateTime?
  subscriptionEndsAt DateTime?
  nextBillingDate    DateTime?
  monthlyBill        Decimal? @default(0)
  autoRenew          Boolean  @default(true)
  
  // AUTO-CLEANUP
  scheduledDeletionAt DateTime?
  deletedAt          DateTime?
  
  // CONTACT
  address            String?
  phone              String?
  email              String?

  // SETTINGS (v2.0)
  currency           String   @default("IDR")
  taxPercentage      Decimal  @default(0)

  // DEALER GROUP (v2.1)
  dealerGroupId      String?
  dealerGroup        DealerGroup?  @relation("GroupMembers", fields: [dealerGroupId], references: [id])

  // Relations
  users        User[]
  vehicles     Vehicle[]
  customers    Customer[]
  transactions Transaction[]
  branches     Branch[]
  vehicleBrands VehicleBrand[]
  blacklistEntries BlacklistEntry[]
  invoices     SystemInvoice[]
  activityLogs ActivityLog[]
  vehicleCosts VehicleCost[]

  // Stock Transfers
  outgoingTransfers StockTransfer[] @relation("SourceTenantTransfer")
  incomingTransfers StockTransfer[] @relation("TargetTenantTransfer")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}

// ==================== DYNAMIC PLANS (v2.1) ====================

model Plan {
  id              String   @id @default(uuid())
  name            String   // Basic, Pro, Enterprise
  slug            String   @unique // basic, pro, enterprise
  description     String?
  
  // Pricing
  price           Decimal  @default(0)
  currency        String   @default("IDR")
  
  // Feature Flags & Limits
  maxVehicles     Int      @default(50)
  maxUsers        Int      @default(3)
  maxBranches     Int      @default(1)
  canCreateGroup  Boolean  @default(false) // KEY for Dealer Group
  maxGroupMembers Int      @default(0)
  
  features        Json?    // UI display features { "api": true, "support": "priority" }
  
  // Relations
  tenants         Tenant[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("plans")
}

// ==================== DEALER GROUP (v2.1) ====================

model DealerGroup {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique // Invite Code (e.g., "WJY-8821")
  
  // Owner (The Induk)
  ownerId     String   @unique
  owner       User     @relation("GroupOwner", fields: [ownerId], references: [id])
  
  // Members (Independent Tenants)
  members     Tenant[] @relation("GroupMembers")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("dealer_groups")
}

// ==================== CMS CONTENT (v2.1) ====================

model LandingPageContent {
  id        String   @id @default("default") // Singleton ID
  hero      Json     // title, subtitle, ctaText, ctaLink, bgImage
  features  Json     // array of {icon, title, desc}
  pricing   Json     // array of plan overrides/highlights
  faq       Json     // array of {question, answer}
  footer    Json     // social links, contacts
  
  updatedAt DateTime @updatedAt
  
  @@map("landing_page_contents")
}

model User {
  id       String @id @default(uuid())
  tenantId String? 
  tenant   Tenant? @relation(fields: [tenantId], references: [id])
  
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  name     String
  username String @unique
  email    String @unique
  password String
  role     String @default("STAFF") 

  // OAUTH
  isOauth              Boolean   @default(false)
  googleId             String?   @unique

  // PASSWORD RESET
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // PROFILE
  phone     String?
  birthDate DateTime?
  address   String?
  language  String   @default("id")

  // VERIFICATION & ONBOARDING
  isVerified              Boolean   @default(false)
  verificationCode        String?
  verificationCodeExpiresAt DateTime?
  onboardingCompleted     Boolean   @default(false)

  // OTP Rate Limiting
  otpAttempts     Int      @default(0)
  otpLastSentAt   DateTime?
  otpBlockedUntil DateTime?
  
  // DEALER GROUP OWNER
  ownedGroup      DealerGroup? @relation("GroupOwner")

  transactions Transaction[]
  activityLogs ActivityLog[]
  refreshTokens RefreshToken[]
  requestedTransfers StockTransfer[] @relation("Requester")
  approvedTransfers  StockTransfer[] @relation("Approver")
  notifications      Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  message   String   @db.Text
  type      String   @default("info") // info | success | warning | error
  link      String?
  read      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@map("notifications")
}

// ... rest of the file ...

// ==================== BRANCH (PREMIUM) ====================

model Branch {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  name    String
  address String
  phone   String?

  vehicles Vehicle[]
  users    User[]
  transactions Transaction[]
  customers    Customer[]
  
  outgoingTransfers StockTransfer[] @relation("SourceBranch")
  incomingTransfers StockTransfer[] @relation("TargetBranch")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("branches")
}

// ==================== MASTER DATA ====================

model VehicleBrand {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  name     String   // Toyota, Honda, Yamaha
  category String   // CAR, MOTORCYCLE, TRUCK

  models VehicleModel[]

  createdAt DateTime @default(now())

  @@unique([tenantId, name, category])
  @@map("vehicle_brands")
}

model VehicleModel {
  id      String       @id @default(uuid())
  brandId String
  brand   VehicleBrand @relation(fields: [brandId], references: [id])

  name     String  // Avanza, Beat, Ranger
  variants String? // JSON array: ["G", "E", "S"]

  createdAt DateTime @default(now())

  @@unique([brandId, name])
  @@map("vehicle_models")
}

// ==================== VEHICLE ====================

model Vehicle {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  // BASIC INFO
  category String // CAR, MOTORCYCLE, TRUCK, BUS, OTHER
  make     String // Brand name
  model    String // Model name
  variant  String?
  year     Int
  color    String

  // PRICING
  purchasePrice Decimal? // Harga beli (modal)
  purchaseDate  DateTime?
  price         Decimal  // Harga jual

  // STATUS
  status        String  @default("AVAILABLE") // AVAILABLE, BOOKED, SOLD
  condition     String  @default("READY")     // READY, REPAIR, RESERVED
  conditionNote String? // "Perbaikan AC, estimasi 3 hari"
  isShowroom    Boolean @default(true)

  // IDENTITAS KENDARAAN
  licensePlate  String?
  engineNumber  String?
  chassisNumber String?
  bpkbNumber    String?  // Nomor BPKB

  // KELENGKAPAN DOKUMEN
  stnkExpiry      DateTime?
  bpkbAvailable   Boolean @default(true)
  fakturAvailable Boolean @default(true)
  serviceBook     Boolean @default(false)
  spareKey        Boolean @default(false)

  // FLEXIBLE DATA
  specs  String? // JSON for additional specs
  images String? // JSON array of image URLs

  // DOKUMEN KENDARAAN (GAMBAR)
  ktpOwnerImage    String? // KTP pemilik sesuai BPKB
  bpkbOwnerName    String? // Nama pemilik di BPKB (jika beda dgn KTP dealer)
  isOwnerDifferent Boolean @default(false) // Flag: Pemilik BPKB â‰  Pemilik KTP
  stnkImage        String? // Foto STNK
  bpkbImage        String? // Foto BPKB
  taxImage         String? // Foto bukti pajak terakhir

  transactions Transaction[]
  costs        VehicleCost[]
  stockTransfers StockTransfer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@map("vehicles")
}

// ==================== CUSTOMER & LEADS ====================

model Customer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  
  branchId String? // Optional: Lead owned by specific branch
  branch   Branch? @relation(fields: [branchId], references: [id])

  // BASIC INFO - KTP as unique per-tenant identifier for blacklist
  ktpNumber String?  // Unique per tenant (see @@unique below) - Optional for LEAD
  name      String
  phone     String
  email     String?
  address   String?

  // LEAD MANAGEMENT (v2.0)
  type          String   @default("CUSTOMER") // CUSTOMER, LEAD
  source        String?  // WALK_IN, INSTAGRAM, ADS, MARKETPLACE
  pipelineStage String?  // NEW, INTERESTED, TEST_DRIVE, NEGOTIATION, WON, LOST
  notes         String?

  // DOKUMEN IDENTITAS
  ktpImage             String?
  kkImage              String? // Kartu Keluarga
  homeProofType        String? // BPKB, ELECTRICITY_BILL
  homeProofImage       String?
  salarySlipImage      String?
  bankStatementImage   String? // Rekening koran 3 bulan
  businessLicenseImage String? // SIUP/NIB

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, ktpNumber])
  @@index([tenantId])
  @@map("customers")
}

// ==================== TRANSACTION & FINANCE ====================

model Transaction {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  branchId String? // v2.0
  branch   Branch? @relation(fields: [branchId], references: [id])

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  salesPersonId String
  salesPerson   User @relation(fields: [salesPersonId], references: [id])

  // TRANSACTION DETAILS
  type        String @default("SALE")     // SALE, PURCHASE
  
  // v2.0 FINANCIALS
  currency           String   @default("IDR")
  paymentType        String   @default("CASH") // CASH, CREDIT, SPLIT
  paymentStatus      String   @default("UNPAID") // UNPAID, PARTIAL, PAID
  
  basePrice          Decimal  // Harga Dasar
  taxPercentage      Decimal  @default(0) // PPN %
  taxAmount          Decimal  @default(0) // Nilai PPN
  finalPrice         Decimal  // Total setelah pajak

  notes       String?

  date   DateTime @default(now())
  status String   @default("PENDING") // PENDING, COMPLETED, CANCELLED

  credit Credit?
  payments TransactionPayment[] // v2.0 Split Payments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([tenantId, status])
  @@map("transactions")
}

model TransactionPayment {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // PAYMENT DETAILS
  method          String   // CASH, TRANSFER, EDC_DEBIT, EDC_CREDIT
  amount          Decimal
  referenceNumber String?  // No. Referensi Transfer/EDC
  note            String?
  date            DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([transactionId])
  @@map("transaction_payments")
}

// ==================== CREDIT / LEASING ====================

model Credit {
  id            String      @id @default(uuid())
  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  // CREDIT TYPE
  creditType     String @default("DEALER_CREDIT") // LEASING, DEALER_CREDIT, DEALER_TO_LEASING
  leasingCompany String? // Nama leasing (Adira, ACC, etc)

  // AMOUNT DETAILS
  downPayment    Decimal // DP
  totalAmount    Decimal // Total kredit (Principal)
  interestRate   Decimal // Bunga % per tahun
  tenorMonths    Int     // 6, 12, 24, 36, 48, 60 atau custom
  monthlyPayment Decimal // Cicilan per bulan

  // TRACKING
  nextDueDate DateTime? // Tanggal jatuh tempo berikutnya
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED, DEFAULTED, TRANSFERRED

  payments CreditPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("credits")
}

model CreditPayment {
  id       String @id @default(uuid())
  creditId String
  credit   Credit @relation(fields: [creditId], references: [id])

  month  Int     // Cicilan ke-berapa
  amount Decimal
  paidAt DateTime
  status String  @default("PAID") // PAID, LATE
  note   String?

  createdAt DateTime @default(now())

  @@map("credit_payments")
}

// ==================== STOCK TRANSFER (v2.0 & Cross-Tenant) ====================

model StockTransfer {
  id             String   @id @default(uuid())
  
  // SOURCE (Initiator)
  tenantId       String
  tenant         Tenant   @relation("SourceTenantTransfer", fields: [tenantId], references: [id])
  
  // TARGET (Recipient) - Optional for internal, but mandatory for cross-tenant logic
  targetTenantId String?
  targetTenant   Tenant?  @relation("TargetTenantTransfer", fields: [targetTenantId], references: [id])
  
  vehicleId      String
  vehicle        Vehicle  @relation(fields: [vehicleId], references: [id])

  // BRANCHES (Optional for Single-Branch Mode)
  sourceBranchId String?
  sourceBranch   Branch?   @relation("SourceBranch", fields: [sourceBranchId], references: [id])

  targetBranchId String?
  targetBranch   Branch?   @relation("TargetBranch", fields: [targetBranchId], references: [id])

  // TRANSFER DETAILS
  type           String   @default("MUTATION") // MUTATION (Free), SALE (Paid)
  price          Decimal? // Required if type is SALE (Deal Price)

  // REQUEST DETAILS
  requestedById  String
  requestedBy    User     @relation("Requester", fields: [requestedById], references: [id])
  
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  
  approvedById   String?
  approvedBy     User?    @relation("Approver", fields: [approvedById], references: [id])
  
  approvedAt     DateTime?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([targetTenantId])
  @@index([status])
  @@map("stock_transfers")
}

// ==================== BLACKLIST (CROSS-TENANT) ====================

model BlacklistEntry {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Customer Info (stored for when customer lookup)
  ktpNumber       String
  customerName    String
  customerAddress String?

  reason    String
  createdAt DateTime @default(now())

  @@unique([ktpNumber, tenantId])
  @@index([ktpNumber])
  @@map("blacklist_entries")
}

// ==================== VEHICLE COST TRACKING ====================

model VehicleCost {
  id        String  @id @default(uuid())
  tenantId  String
  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  costType    String   // PURCHASE, MAINTENANCE, TAX, INSURANCE, OTHER
  amount      Decimal
  description String?
  date        DateTime
  receiptImage String?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("vehicle_costs")
}

// ==================== SYSTEM INVOICE (SUPERADMIN BILLING) ====================

model SystemInvoice {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  invoiceNumber String   @unique // INV-2023-001
  amount        Decimal
  date          DateTime @default(now())
  dueDate       DateTime
  
  status        String   @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED, VERIFYING
  paymentProof  String?  // URL to proof image
  
  items         String?  // JSON description of items

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_invoices")
}

// ==================== ADMIN ACTIVITY LOG (AUDIT TRAIL) ====================

model AdminActivityLog {
  id          String   @id @default(uuid())
  
  userId      String   // Admin who performed the action
  userEmail   String   // For display without join
  
  action      String   // LOGIN, TENANT_CREATE, TENANT_UPDATE, TENANT_SUSPEND, INVOICE_VERIFY, etc.
  entityType  String?  // TENANT, INVOICE, USER, etc.
  entityId    String?  // ID of affected entity
  entityName  String?  // Name for display without join
  
  details     String?  // JSON with additional context
  ipAddress   String?
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_activity_logs")
}

// ==================== TENANT ACTIVITY LOG ====================

model ActivityLog {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  userId    String
  user      User   @relation(fields: [userId], references: [id])
  userEmail String // For display without join

  action     String  // LOGIN, LOGOUT, PASSWORD_CHANGE, CUSTOMER_CREATE, VEHICLE_CREATE, etc.
  entityType String? // CUSTOMER, VEHICLE, TRANSACTION
  entityId   String?
  entityName String?

  details   String? // JSON with additional context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, action])
  @@index([createdAt])
  @@map("activity_logs")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ==================== ADMIN APPROVAL REQUESTS ====================

model AdminApprovalRequest {
  id            String   @id @default(uuid())
  requestedById String
  approvedById  String?
  type          String   // PLAN_CHANGE, BILLING_EXTEND, INVOICE_ACTION, TENANT_SUSPEND
  payload       String   // JSON detail of the change
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  note          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([requestedById])
  @@map("admin_approval_requests")
}

// ==================== API KEYS ====================

model ApiKey {
  id        String    @id @default(uuid())
  name      String
  keyHash   String    @unique
  prefix    String    // First 8 chars for display (e.g. "oh_live_ab")
  scopes    String?   // JSON array of permissions
  lastUsed  DateTime?
  expiresAt DateTime?
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())

  @@index([active])
  @@map("api_keys")
}
